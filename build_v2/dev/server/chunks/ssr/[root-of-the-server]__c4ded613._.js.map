{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 28, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/Dhanush/agronova/context/AuthContext.tsx"],"sourcesContent":["\"use client\";\r\nimport React, { createContext, useContext, useState, useEffect } from \"react\";\r\nimport { useRouter } from \"next/navigation\";\r\n\r\nexport interface User {\r\n  name: string;\r\n  email: string;\r\n  role: \"Admin\" | \"Farmer\" | \"User\";\r\n  phone?: string;\r\n  location?: string;\r\n  farmSize?: string;\r\n  crops?: string[];\r\n  avatar?: string; // Base64 image\r\n  about?: string;\r\n}\r\n\r\ninterface AuthContextType {\r\n  user: User | null;\r\n  isAuthenticated: boolean;\r\n  login: (email: string, password: string) => Promise<boolean>;\r\n  register: (name: string, email: string, password: string) => Promise<boolean>;\r\n  sendOtp: (email: string) => Promise<string>;\r\n  verifyOtp: (email: string, code: string) => Promise<boolean>;\r\n  logout: () => void;\r\n  updateProfile: (updates: Partial<User>) => void;\r\n}\r\n\r\nconst AuthContext = createContext<AuthContextType | undefined>(undefined);\r\n\r\nexport const AuthProvider = ({ children }: { children: React.ReactNode }) => {\r\n  const [user, setUser] = useState<User | null>(null);\r\n  const router = useRouter();\r\n\r\n  // Helper to normalize emails to prevent duplicates via case sensitivity\r\n  const normalize = (email: string) => email.trim().toLowerCase();\r\n\r\n  useEffect(() => {\r\n    // 1. Check local storage for existing session\r\n    const storedUser = localStorage.getItem(\"agronova_user\");\r\n    if (storedUser) {\r\n      setUser(JSON.parse(storedUser));\r\n    }\r\n\r\n    // 2. Seed Test User (Investor Demo)\r\n    const demoEmail = \"demo@agronova.com\";\r\n    const demoKey = `reg_${demoEmail}`;\r\n    if (!localStorage.getItem(demoKey)) {\r\n        console.log(\"Seeding Demo User...\");\r\n        localStorage.setItem(demoKey, JSON.stringify({\r\n            name: \"Investor Demo\",\r\n            password: \"password123\",\r\n            location: \"Bangalore, KA\",\r\n            role: \"Farmer\"\r\n        }));\r\n    }\r\n  }, []);\r\n\r\n  const persistUser = (userData: User) => {\r\n    setUser(userData);\r\n    localStorage.setItem(\"agronova_user\", JSON.stringify(userData));\r\n  };\r\n\r\n  const updateProfile = (updates: Partial<User>) => {\r\n      if (!user) return;\r\n      \r\n      const updatedUser = { ...user, ...updates };\r\n      persistUser(updatedUser);\r\n      \r\n      // Update persistent record (so it survives logout/login)\r\n      const cleanEmail = normalize(user.email);\r\n      // Don't update reg for admin special case unless we want to, \r\n      // but for 'dshenoyh' we used hardcoded check originally.\r\n      // We will now try to save to reg for everyone to ensure persistence.\r\n      \r\n      const regKey = `reg_${cleanEmail}`;\r\n      const storedReg = localStorage.getItem(regKey);\r\n      \r\n      if (storedReg) {\r\n          const currentReg = JSON.parse(storedReg);\r\n          // Preserve password, overwrite other fields\r\n          const newReg = { ...currentReg, ...updates };\r\n          // Remove fields that shouldn't be in reg if any (none really)\r\n          localStorage.setItem(regKey, JSON.stringify(newReg));\r\n      } else {\r\n          // If no reg exists (e.g. hardcoded admin), maybe create one?\r\n          // For now, only persist to session is guaranteed if no reg exists.\r\n      }\r\n  };\r\n\r\n  const login = async (email: string, password: string): Promise<boolean> => {\r\n    await new Promise((resolve) => setTimeout(resolve, 1000));\r\n    const cleanEmail = normalize(email);\r\n\r\n    // 1. Admin Credential Check\r\n    if (cleanEmail === \"dshenoyh@gmail.com\") {\r\n        const storedReg = localStorage.getItem(`reg_${cleanEmail}`);\r\n        if (storedReg) {\r\n             const storedData = JSON.parse(storedReg);\r\n             if (password === storedData.password) {\r\n                 const { password: _, ...profileData } = storedData;\r\n                 persistUser({ ...profileData, email: cleanEmail, role: \"Admin\" });\r\n                 return true;\r\n             }\r\n        } else if (password === \"admin@123\") {\r\n             persistUser({ name: \"Dhanush Shenoy\", email: cleanEmail, role: \"Admin\" });\r\n             return true;\r\n        }\r\n        return false;\r\n    }\r\n\r\n    // 2. Regular / Demo User Check\r\n    const storedReg = localStorage.getItem(`reg_${cleanEmail}`);\r\n    if (storedReg) {\r\n      const storedData = JSON.parse(storedReg);\r\n      if (password === storedData.password) {\r\n        const { password: _, ...profileData } = storedData;\r\n        persistUser({ ...profileData, email: cleanEmail, role: \"Farmer\" });\r\n        return true;\r\n      }\r\n    }\r\n    \r\n    return false;\r\n  };\r\n\r\n  const register = async (name: string, email: string, password: string): Promise<boolean> => {\r\n    await new Promise((resolve) => setTimeout(resolve, 1000));\r\n    const cleanEmail = normalize(email);\r\n\r\n    // Check if loading user already exists (optional but good practice)\r\n    if (localStorage.getItem(`reg_${cleanEmail}`)) {\r\n        // allow overwrite for demo\r\n    }\r\n\r\n    // Initialize with basic data\r\n    localStorage.setItem(`reg_${cleanEmail}`, JSON.stringify({ name, password }));\r\n    \r\n    const role = cleanEmail === \"dshenoyh@gmail.com\" ? \"Admin\" : \"Farmer\";\r\n    persistUser({ name, email: cleanEmail, role });\r\n    return true;\r\n  };\r\n\r\n  const sendOtp = async (email: string): Promise<string> => {\r\n    const cleanEmail = normalize(email);\r\n    \r\n    // Check if user exists (mock check for now, ideally check DB)\r\n    const storedReg = localStorage.getItem(`reg_${cleanEmail}`);\r\n    const isAdmin = cleanEmail === \"dshenoyh@gmail.com\";\r\n    const isDemo = cleanEmail === \"demo@agronova.com\";\r\n\r\n    if (!storedReg && !isAdmin && !isDemo) {\r\n        throw new Error(\"User not found. Please sign up first.\");\r\n    }\r\n\r\n    try {\r\n        const res = await fetch(\"/api/auth/otp/send\", {\r\n            method: \"POST\",\r\n            headers: { \"Content-Type\": \"application/json\" },\r\n            body: JSON.stringify({ email: cleanEmail }),\r\n        });\r\n\r\n        if (!res.ok) {\r\n            const errorData = await res.json();\r\n            throw new Error(errorData.error || \"Failed to send OTP\");\r\n        }\r\n\r\n        const { hash, expiry } = await res.json();\r\n        \r\n        // Store Hash + Expiry in LocalStorage for verification step\r\n        localStorage.setItem(`otp_hash_${cleanEmail}`, JSON.stringify({ hash, expiry }));\r\n        \r\n        return \"Code sent to email!\"; // Return message instead of code\r\n    } catch (error: any) {\r\n        throw new Error(error.message);\r\n    }\r\n  };\r\n\r\n  const verifyOtp = async (email: string, code: string): Promise<boolean> => {\r\n     const cleanEmail = normalize(email);\r\n\r\n     const storedHashData = localStorage.getItem(`otp_hash_${cleanEmail}`);\r\n     \r\n     if (!storedHashData) {\r\n        throw new Error(\"OTP session expired. Please request a new code.\");\r\n     }\r\n\r\n     const { hash, expiry } = JSON.parse(storedHashData);\r\n\r\n     try {\r\n        const res = await fetch(\"/api/auth/otp/verify\", {\r\n            method: \"POST\",\r\n            headers: { \"Content-Type\": \"application/json\" },\r\n            body: JSON.stringify({ email: cleanEmail, otp: code, hash, expiry }),\r\n        });\r\n\r\n        if (!res.ok) {\r\n            const errorData = await res.json();\r\n            throw new Error(errorData.error || \"Invalid OTP\");\r\n        }\r\n        \r\n        // Verification Success -> Log user in\r\n        const storedReg = localStorage.getItem(`reg_${cleanEmail}`);\r\n        let role: \"Admin\" | \"Farmer\" = \"Farmer\";\r\n        let profileData: Partial<User> = { name: \"Farmer\" };\r\n\r\n        if (cleanEmail === \"dshenoyh@gmail.com\") {\r\n            role = \"Admin\";\r\n            profileData = { name: \"Dhanush Shenoy\" };\r\n        } \r\n        \r\n        if (storedReg) {\r\n            const storedData = JSON.parse(storedReg);\r\n            const { password: _, ...rest } = storedData;\r\n            profileData = rest;\r\n        }\r\n\r\n        persistUser({ ...profileData as User, email: cleanEmail, role });\r\n        localStorage.removeItem(`otp_hash_${cleanEmail}`); // Clear OTP hash after success\r\n        return true;\r\n\r\n     } catch (error: any) {\r\n         throw new Error(error.message);\r\n     }\r\n  };\r\n\r\n  const logout = () => {\r\n    setUser(null);\r\n    localStorage.removeItem(\"agronova_user\");\r\n    router.push(\"/login\");\r\n  };\r\n\r\n  return (\r\n    <AuthContext.Provider\r\n      value={{\r\n        user,\r\n        isAuthenticated: !!user,\r\n        login,\r\n        register,\r\n        sendOtp,\r\n        verifyOtp,\r\n        logout,\r\n        updateProfile,\r\n      }}\r\n    >\r\n      {children}\r\n    </AuthContext.Provider>\r\n  );\r\n};\r\n\r\nexport const useAuth = () => {\r\n  const context = useContext(AuthContext);\r\n  if (context === undefined) {\r\n    throw new Error(\"useAuth must be used within an AuthProvider\");\r\n  }\r\n  return context;\r\n};\r\n"],"names":[],"mappings":";;;;;;;AACA;AACA;AAFA;;;;AA2BA,MAAM,4BAAc,IAAA,kOAAa,EAA8B;AAExD,MAAM,eAAe,CAAC,EAAE,QAAQ,EAAiC;IACtE,MAAM,CAAC,MAAM,QAAQ,GAAG,IAAA,6NAAQ,EAAc;IAC9C,MAAM,SAAS,IAAA,2JAAS;IAExB,wEAAwE;IACxE,MAAM,YAAY,CAAC,QAAkB,MAAM,IAAI,GAAG,WAAW;IAE7D,IAAA,8NAAS,EAAC;QACR,8CAA8C;QAC9C,MAAM,aAAa,aAAa,OAAO,CAAC;QACxC,IAAI,YAAY;YACd,QAAQ,KAAK,KAAK,CAAC;QACrB;QAEA,oCAAoC;QACpC,MAAM,YAAY;QAClB,MAAM,UAAU,CAAC,IAAI,EAAE,WAAW;QAClC,IAAI,CAAC,aAAa,OAAO,CAAC,UAAU;YAChC,QAAQ,GAAG,CAAC;YACZ,aAAa,OAAO,CAAC,SAAS,KAAK,SAAS,CAAC;gBACzC,MAAM;gBACN,UAAU;gBACV,UAAU;gBACV,MAAM;YACV;QACJ;IACF,GAAG,EAAE;IAEL,MAAM,cAAc,CAAC;QACnB,QAAQ;QACR,aAAa,OAAO,CAAC,iBAAiB,KAAK,SAAS,CAAC;IACvD;IAEA,MAAM,gBAAgB,CAAC;QACnB,IAAI,CAAC,MAAM;QAEX,MAAM,cAAc;YAAE,GAAG,IAAI;YAAE,GAAG,OAAO;QAAC;QAC1C,YAAY;QAEZ,yDAAyD;QACzD,MAAM,aAAa,UAAU,KAAK,KAAK;QACvC,8DAA8D;QAC9D,yDAAyD;QACzD,qEAAqE;QAErE,MAAM,SAAS,CAAC,IAAI,EAAE,YAAY;QAClC,MAAM,YAAY,aAAa,OAAO,CAAC;QAEvC,IAAI,WAAW;YACX,MAAM,aAAa,KAAK,KAAK,CAAC;YAC9B,4CAA4C;YAC5C,MAAM,SAAS;gBAAE,GAAG,UAAU;gBAAE,GAAG,OAAO;YAAC;YAC3C,8DAA8D;YAC9D,aAAa,OAAO,CAAC,QAAQ,KAAK,SAAS,CAAC;QAChD,OAAO;QACH,6DAA6D;QAC7D,mEAAmE;QACvE;IACJ;IAEA,MAAM,QAAQ,OAAO,OAAe;QAClC,MAAM,IAAI,QAAQ,CAAC,UAAY,WAAW,SAAS;QACnD,MAAM,aAAa,UAAU;QAE7B,4BAA4B;QAC5B,IAAI,eAAe,sBAAsB;YACrC,MAAM,YAAY,aAAa,OAAO,CAAC,CAAC,IAAI,EAAE,YAAY;YAC1D,IAAI,WAAW;gBACV,MAAM,aAAa,KAAK,KAAK,CAAC;gBAC9B,IAAI,aAAa,WAAW,QAAQ,EAAE;oBAClC,MAAM,EAAE,UAAU,CAAC,EAAE,GAAG,aAAa,GAAG;oBACxC,YAAY;wBAAE,GAAG,WAAW;wBAAE,OAAO;wBAAY,MAAM;oBAAQ;oBAC/D,OAAO;gBACX;YACL,OAAO,IAAI,aAAa,aAAa;gBAChC,YAAY;oBAAE,MAAM;oBAAkB,OAAO;oBAAY,MAAM;gBAAQ;gBACvE,OAAO;YACZ;YACA,OAAO;QACX;QAEA,+BAA+B;QAC/B,MAAM,YAAY,aAAa,OAAO,CAAC,CAAC,IAAI,EAAE,YAAY;QAC1D,IAAI,WAAW;YACb,MAAM,aAAa,KAAK,KAAK,CAAC;YAC9B,IAAI,aAAa,WAAW,QAAQ,EAAE;gBACpC,MAAM,EAAE,UAAU,CAAC,EAAE,GAAG,aAAa,GAAG;gBACxC,YAAY;oBAAE,GAAG,WAAW;oBAAE,OAAO;oBAAY,MAAM;gBAAS;gBAChE,OAAO;YACT;QACF;QAEA,OAAO;IACT;IAEA,MAAM,WAAW,OAAO,MAAc,OAAe;QACnD,MAAM,IAAI,QAAQ,CAAC,UAAY,WAAW,SAAS;QACnD,MAAM,aAAa,UAAU;QAE7B,oEAAoE;QACpE,IAAI,aAAa,OAAO,CAAC,CAAC,IAAI,EAAE,YAAY,GAAG;QAC3C,2BAA2B;QAC/B;QAEA,6BAA6B;QAC7B,aAAa,OAAO,CAAC,CAAC,IAAI,EAAE,YAAY,EAAE,KAAK,SAAS,CAAC;YAAE;YAAM;QAAS;QAE1E,MAAM,OAAO,eAAe,uBAAuB,UAAU;QAC7D,YAAY;YAAE;YAAM,OAAO;YAAY;QAAK;QAC5C,OAAO;IACT;IAEA,MAAM,UAAU,OAAO;QACrB,MAAM,aAAa,UAAU;QAE7B,8DAA8D;QAC9D,MAAM,YAAY,aAAa,OAAO,CAAC,CAAC,IAAI,EAAE,YAAY;QAC1D,MAAM,UAAU,eAAe;QAC/B,MAAM,SAAS,eAAe;QAE9B,IAAI,CAAC,aAAa,CAAC,WAAW,CAAC,QAAQ;YACnC,MAAM,IAAI,MAAM;QACpB;QAEA,IAAI;YACA,MAAM,MAAM,MAAM,MAAM,sBAAsB;gBAC1C,QAAQ;gBACR,SAAS;oBAAE,gBAAgB;gBAAmB;gBAC9C,MAAM,KAAK,SAAS,CAAC;oBAAE,OAAO;gBAAW;YAC7C;YAEA,IAAI,CAAC,IAAI,EAAE,EAAE;gBACT,MAAM,YAAY,MAAM,IAAI,IAAI;gBAChC,MAAM,IAAI,MAAM,UAAU,KAAK,IAAI;YACvC;YAEA,MAAM,EAAE,IAAI,EAAE,MAAM,EAAE,GAAG,MAAM,IAAI,IAAI;YAEvC,4DAA4D;YAC5D,aAAa,OAAO,CAAC,CAAC,SAAS,EAAE,YAAY,EAAE,KAAK,SAAS,CAAC;gBAAE;gBAAM;YAAO;YAE7E,OAAO,uBAAuB,iCAAiC;QACnE,EAAE,OAAO,OAAY;YACjB,MAAM,IAAI,MAAM,MAAM,OAAO;QACjC;IACF;IAEA,MAAM,YAAY,OAAO,OAAe;QACrC,MAAM,aAAa,UAAU;QAE7B,MAAM,iBAAiB,aAAa,OAAO,CAAC,CAAC,SAAS,EAAE,YAAY;QAEpE,IAAI,CAAC,gBAAgB;YAClB,MAAM,IAAI,MAAM;QACnB;QAEA,MAAM,EAAE,IAAI,EAAE,MAAM,EAAE,GAAG,KAAK,KAAK,CAAC;QAEpC,IAAI;YACD,MAAM,MAAM,MAAM,MAAM,wBAAwB;gBAC5C,QAAQ;gBACR,SAAS;oBAAE,gBAAgB;gBAAmB;gBAC9C,MAAM,KAAK,SAAS,CAAC;oBAAE,OAAO;oBAAY,KAAK;oBAAM;oBAAM;gBAAO;YACtE;YAEA,IAAI,CAAC,IAAI,EAAE,EAAE;gBACT,MAAM,YAAY,MAAM,IAAI,IAAI;gBAChC,MAAM,IAAI,MAAM,UAAU,KAAK,IAAI;YACvC;YAEA,sCAAsC;YACtC,MAAM,YAAY,aAAa,OAAO,CAAC,CAAC,IAAI,EAAE,YAAY;YAC1D,IAAI,OAA2B;YAC/B,IAAI,cAA6B;gBAAE,MAAM;YAAS;YAElD,IAAI,eAAe,sBAAsB;gBACrC,OAAO;gBACP,cAAc;oBAAE,MAAM;gBAAiB;YAC3C;YAEA,IAAI,WAAW;gBACX,MAAM,aAAa,KAAK,KAAK,CAAC;gBAC9B,MAAM,EAAE,UAAU,CAAC,EAAE,GAAG,MAAM,GAAG;gBACjC,cAAc;YAClB;YAEA,YAAY;gBAAE,GAAG,WAAW;gBAAU,OAAO;gBAAY;YAAK;YAC9D,aAAa,UAAU,CAAC,CAAC,SAAS,EAAE,YAAY,GAAG,+BAA+B;YAClF,OAAO;QAEV,EAAE,OAAO,OAAY;YACjB,MAAM,IAAI,MAAM,MAAM,OAAO;QACjC;IACH;IAEA,MAAM,SAAS;QACb,QAAQ;QACR,aAAa,UAAU,CAAC;QACxB,OAAO,IAAI,CAAC;IACd;IAEA,qBACE,0PAAC,YAAY,QAAQ;QACnB,OAAO;YACL;YACA,iBAAiB,CAAC,CAAC;YACnB;YACA;YACA;YACA;YACA;YACA;QACF;kBAEC;;;;;;AAGP;AAEO,MAAM,UAAU;IACrB,MAAM,UAAU,IAAA,+NAAU,EAAC;IAC3B,IAAI,YAAY,WAAW;QACzB,MAAM,IAAI,MAAM;IAClB;IACA,OAAO;AACT"}},
    {"offset": {"line": 281, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/Dhanush/agronova/components/theme-provider.tsx"],"sourcesContent":["\"use client\";\r\n\r\nimport React, { createContext, useContext, useEffect, useState } from \"react\";\r\n\r\ntype Theme = \"light\" | \"dark\";\r\n\r\ntype ThemeProviderProps = {\r\n  children: React.ReactNode;\r\n  defaultTheme?: Theme;\r\n  storageKey?: string;\r\n};\r\n\r\ntype ThemeProviderState = {\r\n  theme: Theme;\r\n  setTheme: (theme: Theme) => void;\r\n};\r\n\r\nconst initialState: ThemeProviderState = {\r\n  theme: \"light\",\r\n  setTheme: () => null,\r\n};\r\n\r\nconst ThemeProviderContext = createContext<ThemeProviderState>(initialState);\r\n\r\nexport function ThemeProvider({\r\n  children,\r\n  defaultTheme = \"light\",\r\n  storageKey = \"vite-ui-theme\",\r\n}: ThemeProviderProps) {\r\n  const [theme, setTheme] = useState<Theme>(defaultTheme); // Start with default to avoid mismatch\r\n\r\n  useEffect(() => {\r\n     // Client-side: Read from storage\r\n     const stored = localStorage.getItem(storageKey) as Theme;\r\n     if (stored) setTheme(stored);\r\n  }, [storageKey]);\r\n\r\n  useEffect(() => {\r\n    const root = window.document.documentElement;\r\n    root.classList.remove(\"light\", \"dark\");\r\n    root.classList.add(theme);\r\n    localStorage.setItem(storageKey, theme);\r\n  }, [theme, storageKey]);\r\n\r\n  const value = {\r\n    theme,\r\n    setTheme: (theme: Theme) => {\r\n      setTheme(theme);\r\n    },\r\n  };\r\n\r\n  return (\r\n    <ThemeProviderContext.Provider value={value}>\r\n      {children}\r\n    </ThemeProviderContext.Provider>\r\n  );\r\n}\r\n\r\nexport const useTheme = () => {\r\n  const context = useContext(ThemeProviderContext);\r\n  if (context === undefined)\r\n    throw new Error(\"useTheme must be used within a ThemeProvider\");\r\n  return context;\r\n};\r\n"],"names":[],"mappings":";;;;;;;AAEA;AAFA;;;AAiBA,MAAM,eAAmC;IACvC,OAAO;IACP,UAAU,IAAM;AAClB;AAEA,MAAM,qCAAuB,IAAA,kOAAa,EAAqB;AAExD,SAAS,cAAc,EAC5B,QAAQ,EACR,eAAe,OAAO,EACtB,aAAa,eAAe,EACT;IACnB,MAAM,CAAC,OAAO,SAAS,GAAG,IAAA,6NAAQ,EAAQ,eAAe,uCAAuC;IAEhG,IAAA,8NAAS,EAAC;QACP,iCAAiC;QACjC,MAAM,SAAS,aAAa,OAAO,CAAC;QACpC,IAAI,QAAQ,SAAS;IACxB,GAAG;QAAC;KAAW;IAEf,IAAA,8NAAS,EAAC;QACR,MAAM,OAAO,OAAO,QAAQ,CAAC,eAAe;QAC5C,KAAK,SAAS,CAAC,MAAM,CAAC,SAAS;QAC/B,KAAK,SAAS,CAAC,GAAG,CAAC;QACnB,aAAa,OAAO,CAAC,YAAY;IACnC,GAAG;QAAC;QAAO;KAAW;IAEtB,MAAM,QAAQ;QACZ;QACA,UAAU,CAAC;YACT,SAAS;QACX;IACF;IAEA,qBACE,0PAAC,qBAAqB,QAAQ;QAAC,OAAO;kBACnC;;;;;;AAGP;AAEO,MAAM,WAAW;IACtB,MAAM,UAAU,IAAA,+NAAU,EAAC;IAC3B,IAAI,YAAY,WACd,MAAM,IAAI,MAAM;IAClB,OAAO;AACT"}}]
}