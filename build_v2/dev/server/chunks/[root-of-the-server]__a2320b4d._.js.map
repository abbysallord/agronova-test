{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 58, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/Dhanush/agronova/lib/db.ts"],"sourcesContent":["import fs from 'fs';\r\nimport path from 'path';\r\n\r\nconst DATA_DIR = 'c:/Users/Dhanush/agronova/data'; // path.join(process.cwd(), 'data');\r\nconst ORDERS_FILE = path.join(DATA_DIR, 'orders.json');\r\nconst USERS_FILE = path.join(DATA_DIR, 'users.json');\r\n\r\n// Ensure data directory exists\r\nif (!fs.existsSync(DATA_DIR)) {\r\n    fs.mkdirSync(DATA_DIR, { recursive: true });\r\n}\r\n\r\n// Types\r\nexport interface Order {\r\n    id: string;\r\n    buyerEmail: string;\r\n    sellerVpa: string; // The \"Seller\" ID in this context\r\n    amount: number;\r\n    items: any[];\r\n    status: 'PENDING_BUYER' | 'PENDING_SELLER' | 'VERIFIED' | 'FAILED' | 'DISPUTED';\r\n    createdAt: string;\r\n    tries: number;\r\n    buyerUpiIndex?: string; // Captured from Buyer Input\r\n    shippingAddress: string;\r\n}\r\n\r\nexport interface Strike {\r\n    id: string;\r\n    date: string;\r\n    reason: string;\r\n    orderId: string;\r\n    active: boolean; // If false, it was removed/forgiven\r\n}\r\n\r\nexport interface User {\r\n    email: string; // or UPI ID\r\n    name?: string;\r\n    role?: string;\r\n    strikes: Strike[];\r\n    status: 'CLEAR' | 'YELLOW' | 'RED' | 'BLACK';\r\n    followers?: string[];\r\n    following?: string[];\r\n}\r\n\r\n// Helpers\r\nfunction readJSON<T>(file: string, defaultValue: T): T {\r\n    if (!fs.existsSync(file)) return defaultValue;\r\n    try {\r\n        const data = fs.readFileSync(file, 'utf-8');\r\n        return JSON.parse(data);\r\n    } catch (e) {\r\n        return defaultValue;\r\n    }\r\n}\r\n\r\nfunction writeJSON(file: string, data: any) {\r\n    fs.writeFileSync(file, JSON.stringify(data, null, 2));\r\n}\r\n\r\n// --- Orders API ---\r\n\r\nexport const dbOrders = {\r\n    getAll: () => readJSON<Order[]>(ORDERS_FILE, []),\r\n    \r\n    getById: (id: string) => {\r\n        const orders = readJSON<Order[]>(ORDERS_FILE, []);\r\n        return orders.find(o => o.id === id);\r\n    },\r\n\r\n    create: (order: Order) => {\r\n        const orders = readJSON<Order[]>(ORDERS_FILE, []);\r\n        orders.push(order);\r\n        writeJSON(ORDERS_FILE, orders);\r\n        return order;\r\n    },\r\n\r\n    update: (id: string, updates: Partial<Order>) => {\r\n        const orders = readJSON<Order[]>(ORDERS_FILE, []);\r\n        const index = orders.findIndex(o => o.id === id);\r\n        if (index === -1) return null;\r\n        \r\n        orders[index] = { ...orders[index], ...updates };\r\n        writeJSON(ORDERS_FILE, orders);\r\n        return orders[index];\r\n    }\r\n};\r\n\r\n// --- Users API (Malpractice) ---\r\n\r\nexport const dbUsers = {\r\n    getAll: () => readJSON<User[]>(USERS_FILE, []),\r\n\r\n    get: (email: string) => {\r\n        const users = readJSON<User[]>(USERS_FILE, []);\r\n        return users.find(u => u.email === email);\r\n    },\r\n\r\n    // Add or Get User (Safe Create)\r\n    ensure: (userData: Partial<User> & { email: string }) => {\r\n        const users = readJSON<User[]>(USERS_FILE, []);\r\n        let user = users.find(u => u.email === userData.email);\r\n        if (!user) {\r\n            user = { \r\n                email: userData.email, \r\n                strikes: [], \r\n                status: 'CLEAR',\r\n                name: userData.name || userData.email.split('@')[0], \r\n                role: userData.role || 'Farmer',\r\n                followers: userData.followers || [],\r\n                following: userData.following || []\r\n            } as any; // Cast to avoid strict type issues with extended fields if User interface isn't fully updated yet (I updated it previously but name/role might be missing in Interface?)\r\n            // Actually I need to add name/role to User Interface too? yes.\r\n            users.push(user);\r\n            writeJSON(USERS_FILE, users);\r\n        }\r\n        return user;\r\n    },\r\n\r\n    addStrike: (email: string, reason: string, orderId: string) => {\r\n        const users = readJSON<User[]>(USERS_FILE, []);\r\n        const index = users.findIndex(u => u.email === email);\r\n        \r\n        if (index === -1) {\r\n            // Create user if not exists\r\n            const newUser: User = { \r\n                email, \r\n                strikes: [{ id: Date.now().toString(), date: new Date().toISOString(), reason, orderId, active: true }], \r\n                status: 'CLEAR' // Will update below\r\n            };\r\n            users.push(newUser);\r\n            // Recalculate status\r\n            updateUserStatus(newUser);\r\n            writeJSON(USERS_FILE, users);\r\n            return newUser;\r\n        }\r\n\r\n        const user = users[index];\r\n        user.strikes.push({ id: Date.now().toString(), date: new Date().toISOString(), reason, orderId, active: true });\r\n        updateUserStatus(user);\r\n        writeJSON(USERS_FILE, users);\r\n        return user;\r\n    },\r\n\r\n    removeStrike: (email: string, strikeId: string) => {\r\n         const users = readJSON<User[]>(USERS_FILE, []);\r\n         const user = users.find(u => u.email === email);\r\n         if (!user) return null;\r\n\r\n         const strike = user.strikes.find(s => s.id === strikeId);\r\n         if (strike) {\r\n             strike.active = false; // Soft delete\r\n             updateUserStatus(user);\r\n             writeJSON(USERS_FILE, users);\r\n         }\r\n         return user;\r\n    }\r\n};\r\n\r\nfunction updateUserStatus(user: User) {\r\n    const activeStrikes = user.strikes.filter(s => s.active).length;\r\n    if (activeStrikes === 0) user.status = 'CLEAR';\r\n    else if (activeStrikes === 1) user.status = 'YELLOW';\r\n    else if (activeStrikes === 2) user.status = 'RED';\r\n    else if (activeStrikes >= 3) user.status = 'BLACK';\r\n}\r\n\r\n// --- Community API ---\r\n\r\n// --- Community API ---\r\n\r\nconst POSTS_FILE = path.join(DATA_DIR, 'posts.json');\r\n\r\nexport interface Comment {\r\n    id: string;\r\n    userEmail: string;\r\n    userName: string;\r\n    text: string;\r\n    date: string;\r\n}\r\n\r\nexport interface Post {\r\n    id: string;\r\n    userEmail: string; // Author\r\n    userName: string;\r\n    userRole: string; // Farmer/Admin\r\n    content: string;\r\n    image?: string; // Base64 or URL\r\n    likes: string[]; // List of user emails who liked\r\n    comments: Comment[];\r\n    date: string;\r\n}\r\n\r\nexport const dbPosts = {\r\n    getAll: () => {\r\n        const posts = readJSON<Post[]>(POSTS_FILE, []);\r\n        return posts.sort((a, b) => new Date(b.date).getTime() - new Date(a.date).getTime());\r\n    },\r\n\r\n    create: (post: Omit<Post, 'id' | 'likes' | 'comments' | 'date'>) => {\r\n        const posts = readJSON<Post[]>(POSTS_FILE, []);\r\n        console.log(`[DB] Creating post. Current count: ${posts.length}`);\r\n        const newPost: Post = {\r\n            ...post,\r\n            id: Date.now().toString(),\r\n            likes: [],\r\n            comments: [],\r\n            date: new Date().toISOString()\r\n        };\r\n        posts.push(newPost);\r\n        writeJSON(POSTS_FILE, posts);\r\n        console.log(`[DB] Post created. New count: ${posts.length}`);\r\n        return newPost;\r\n    },\r\n\r\n    toggleLike: (postId: string, userEmail: string) => {\r\n        const posts = readJSON<Post[]>(POSTS_FILE, []);\r\n        const post = posts.find(p => p.id === postId);\r\n        if (!post) return null;\r\n\r\n        const idx = post.likes.indexOf(userEmail);\r\n        if (idx === -1) {\r\n            post.likes.push(userEmail);\r\n        } else {\r\n            post.likes.splice(idx, 1);\r\n        }\r\n        writeJSON(POSTS_FILE, posts);\r\n        return post;\r\n    },\r\n\r\n    addComment: (postId: string, comment: Omit<Comment, 'id' | 'date'>) => {\r\n        const posts = readJSON<Post[]>(POSTS_FILE, []);\r\n        const post = posts.find(p => p.id === postId);\r\n        if (!post) return null;\r\n\r\n        const newComment: Comment = {\r\n            ...comment,\r\n            id: Date.now().toString(),\r\n            date: new Date().toISOString()\r\n        };\r\n        post.comments.push(newComment);\r\n        writeJSON(POSTS_FILE, posts);\r\n        return newComment;\r\n    },\r\n\r\n    deleteComment: (postId: string, commentId: string, userEmail: string) => {\r\n        const posts = readJSON<Post[]>(POSTS_FILE, []);\r\n        const post = posts.find(p => p.id === postId);\r\n        if (!post) return null;\r\n\r\n        const commentIdx = post.comments.findIndex(c => c.id === commentId);\r\n        if (commentIdx === -1) return null;\r\n\r\n        const comment = post.comments[commentIdx];\r\n        const isCommentOwner = comment.userEmail.toLowerCase().trim() === userEmail.toLowerCase().trim();\r\n        const isPostOwner = post.userEmail.toLowerCase().trim() === userEmail.toLowerCase().trim();\r\n\r\n        if (!isCommentOwner && !isPostOwner) return null; // Unauthorized\r\n\r\n        post.comments.splice(commentIdx, 1);\r\n        writeJSON(POSTS_FILE, posts);\r\n        return post;\r\n    },\r\n\r\n    delete: (postId: string, userEmail: string) => {\r\n        const safeEmail = userEmail?.toLowerCase().trim();\r\n        console.log(`[DB] Request Delete Post ${postId} by ${safeEmail}`);\r\n        \r\n        let posts = readJSON<Post[]>(POSTS_FILE, []);\r\n        const post = posts.find(p => p.id === postId);\r\n        \r\n        if (!post) {\r\n            console.log(`[DB] Post ${postId} not found.`);\r\n            return false;\r\n        }\r\n\r\n        const postOwner = post.userEmail?.toLowerCase().trim();\r\n        console.log(`[DB] Found Post. Owner: ${postOwner}, Requestor: ${safeEmail}`);\r\n\r\n        if (postOwner !== safeEmail) {\r\n            console.log(`[DB] Unauthorized delete attempt.`);\r\n            return false;\r\n        }\r\n        \r\n        posts = posts.filter(p => p.id !== postId);\r\n        console.log(`[DB] Writing ${posts.length} posts to file.`);\r\n        writeJSON(POSTS_FILE, posts);\r\n        return true;\r\n    },\r\n\r\n    edit: (postId: string, userEmail: string, newContent: string) => {\r\n        const posts = readJSON<Post[]>(POSTS_FILE, []);\r\n        const post = posts.find(p => p.id === postId);\r\n        if (!post || post.userEmail.toLowerCase().trim() !== userEmail.toLowerCase().trim()) return null;\r\n\r\n        post.content = newContent;\r\n        writeJSON(POSTS_FILE, posts);\r\n        return post;\r\n    }\r\n};\r\n\r\n// --- Social & Messages API ---\r\n\r\nconst MESSAGES_FILE = path.join(DATA_DIR, 'messages.json');\r\n\r\nexport interface Message {\r\n    id: string;\r\n    sender: string;\r\n    receiver: string;\r\n    content: string;\r\n    timestamp: string;\r\n    read: boolean;\r\n    reactions?: Record<string, string>;\r\n    replyToId?: string;\r\n    edited?: boolean;\r\n}\r\n\r\nexport const dbSocial = {\r\n    toggleFollow: (userEmail: string, targetEmail: string) => {\r\n        const users = readJSON<User[]>(USERS_FILE, []);\r\n        const user = users.find(u => u.email === userEmail);\r\n        const target = users.find(u => u.email === targetEmail);\r\n        \r\n        if (!user || !target) return false;\r\n\r\n        if (!user.following) user.following = [];\r\n        if (!target.followers) target.followers = [];\r\n\r\n        const idx = user.following.indexOf(targetEmail);\r\n        if (idx === -1) {\r\n            user.following.push(targetEmail);\r\n            target.followers.push(userEmail);\r\n        } else {\r\n            user.following.splice(idx, 1);\r\n            const tIdx = target.followers.indexOf(userEmail);\r\n            if (tIdx !== -1) target.followers.splice(tIdx, 1);\r\n        }\r\n\r\n        writeJSON(USERS_FILE, users);\r\n        return true;\r\n    },\r\n\r\n    getMessages: (userEmail: string) => {\r\n        let msgs = readJSON<Message[]>(MESSAGES_FILE, []);\r\n        \r\n        // Auto-Delete > 24h\r\n        const now = Date.now();\r\n        const ONE_DAY = 24 * 60 * 60 * 1000;\r\n        // const ONE_DAY = 2 * 60 * 1000; // Debug: 2 mins\r\n        const initialLen = msgs.length;\r\n        msgs = msgs.filter(m => (now - new Date(m.timestamp).getTime()) < ONE_DAY);\r\n        if (msgs.length !== initialLen) writeJSON(MESSAGES_FILE, msgs);\r\n\r\n        return msgs.filter(m => m.sender === userEmail || m.receiver === userEmail)\r\n                   .sort((a,b) => new Date(a.timestamp).getTime() - new Date(b.timestamp).getTime());\r\n    },\r\n\r\n    sendMessage: (sender: string, receiver: string, content: string, replyToId?: string) => {\r\n        const msgs = readJSON<Message[]>(MESSAGES_FILE, []);\r\n        const newMsg: Message = {\r\n            id: Date.now().toString(),\r\n            sender,\r\n            receiver,\r\n            content,\r\n            timestamp: new Date().toISOString(),\r\n            read: false,\r\n            reactions: {},\r\n            replyToId\r\n        };\r\n        msgs.push(newMsg);\r\n        writeJSON(MESSAGES_FILE, msgs);\r\n        return newMsg;\r\n    },\r\n\r\n    deleteMessage: (msgId: string, userEmail: string) => {\r\n        let msgs = readJSON<Message[]>(MESSAGES_FILE, []);\r\n        const msg = msgs.find(m => m.id === msgId);\r\n        // Allow sender or receiver to delete? Usually only sender deletes for everyone.\r\n        if (!msg || msg.sender !== userEmail) return false;\r\n\r\n        msgs = msgs.filter(m => m.id !== msgId);\r\n        writeJSON(MESSAGES_FILE, msgs);\r\n        return true;\r\n    },\r\n\r\n    editMessage: (msgId: string, userEmail: string, newContent: string) => {\r\n        const msgs = readJSON<Message[]>(MESSAGES_FILE, []);\r\n        const msg = msgs.find(m => m.id === msgId);\r\n        if (!msg || msg.sender !== userEmail) return null;\r\n\r\n        msg.content = newContent;\r\n        msg.edited = true;\r\n        writeJSON(MESSAGES_FILE, msgs);\r\n        return msg;\r\n    },\r\n\r\n    reactMessage: (msgId: string, userEmail: string, emoji: string) => {\r\n        const msgs = readJSON<Message[]>(MESSAGES_FILE, []);\r\n        const msg = msgs.find(m => m.id === msgId);\r\n        if (!msg) return null;\r\n\r\n        if (!msg.reactions) msg.reactions = {};\r\n        if (msg.reactions[userEmail] === emoji) delete msg.reactions[userEmail];\r\n        else msg.reactions[userEmail] = emoji;\r\n        \r\n        writeJSON(MESSAGES_FILE, msgs);\r\n        return msg;\r\n    }\r\n};\r\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 374, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/Dhanush/agronova/lib/email-templates.ts"],"sourcesContent":["export const EmailTemplate = {\r\n    Invoice: (orderId: string, amount: number, items: any[]) => `\r\n        <div style=\"font-family: sans-serif; max-w: 600px; margin: 0 auto; padding: 20px; border: 1px solid #eee; border-radius: 10px;\">\r\n            <h1 style=\"color: #16a34a;\">Order Received!</h1>\r\n            <p>Hi there,</p>\r\n            <p>Thank you for your purchase. We have received your payment request for <strong>Order #${orderId}</strong>.</p>\r\n            <p>Your order is currently <strong>Processing Verification</strong> by the seller.</p>\r\n            \r\n            <div style=\"background: #f9fafb; padding: 15px; border-radius: 8px; margin: 20px 0;\">\r\n                <h3 style=\"margin-top: 0;\">Order Details</h3>\r\n                <ul style=\"padding-left: 20px;\">\r\n                    ${items.map(i => `<li>${i.name} x ${i.quantity} - ₹${i.price * i.quantity}</li>`).join('')}\r\n                </ul>\r\n                <p><strong>Total Paid: ₹${amount.toFixed(2)}</strong></p>\r\n            </div>\r\n\r\n            <p>You will receive a confirmation once the seller verifies the transaction.</p>\r\n        </div>\r\n    `,\r\n\r\n    SellerVerification: (orderId: string, amount: number, buyerUpiId: string, verifyLink: string) => `\r\n        <div style=\"font-family: sans-serif; max-w: 600px; margin: 0 auto; padding: 20px; border: 1px solid #eee; border-radius: 10px;\">\r\n            <h1 style=\"color: #2563eb;\">Action Required: Verify Payment</h1>\r\n            <p>Hello Seller,</p>\r\n            <p>You have a new order <strong>#${orderId}</strong> for <strong>₹${amount.toFixed(2)}</strong>.</p>\r\n            \r\n            <div style=\"background: #eff6ff; padding: 15px; border-radius: 8px; margin: 20px 0; border-left: 4px solid #2563eb;\">\r\n                <p style=\"margin: 0;\"><strong>Buyer UPI/Ref:</strong> ${buyerUpiId}</p>\r\n                <p style=\"margin: 5px 0 0;\">(Please check your Bank Statement for this transaction)</p>\r\n            </div>\r\n\r\n            <p>To accept this order and view shipping details, you MUST verify the payment.</p>\r\n            \r\n            <a href=\"${verifyLink}\" style=\"display: inline-block; background: #2563eb; color: white; padding: 12px 24px; text-decoration: none; border-radius: 6px; font-weight: bold;\">Verify Payment Now</a>\r\n            \r\n            <p style=\"font-size: 12px; color: #666; margin-top: 20px;\">If you did not receive this payment, click the link and report it.</p>\r\n        </div>\r\n    `,\r\n\r\n    SellerSuccess: (orderId: string, address: string) => `\r\n        <div style=\"font-family: sans-serif; max-w: 600px; margin: 0 auto; padding: 20px; border: 1px solid #eee; border-radius: 10px;\">\r\n            <h1 style=\"color: #16a34a;\">Order Verified!</h1>\r\n            <p>Great! You have confirmed the payment for Order <strong>#${orderId}</strong>.</p>\r\n            \r\n            <div style=\"background: #f0fdf4; padding: 15px; border-radius: 8px; margin: 20px 0; border: 1px solid #bbf7d0;\">\r\n                <h3 style=\"margin-top: 0; color: #166534;\">Shipping Details</h3>\r\n                <p style=\"white-space: pre-wrap;\">${address}</p>\r\n            </div>\r\n\r\n            <p>Please ship the items as soon as possible.</p>\r\n        </div>\r\n    `,\r\n\r\n    BuyerFailed: (orderId: string) => `\r\n        <div style=\"font-family: sans-serif; max-w: 600px; margin: 0 auto; padding: 20px; border: 1px solid #eee; border-radius: 10px;\">\r\n            <h1 style=\"color: #dc2626;\">Payment Failed</h1>\r\n            <p>We are sorry, but the seller could not verify your payment for Order <strong>#${orderId}</strong>.</p>\r\n            <p>This order has been cancelled.</p>\r\n            <p>If you believe this is an error, please reply to this email immediately with your payment proof (Screenshot/UTR).</p>\r\n        </div>\r\n    `\r\n};\r\n"],"names":[],"mappings":";;;;AAAO,MAAM,gBAAgB;IACzB,SAAS,CAAC,SAAiB,QAAgB,QAAiB,CAAC;;;;qGAIoC,EAAE,QAAQ;;;;;;oBAM3F,EAAE,MAAM,GAAG,CAAC,CAAA,IAAK,CAAC,IAAI,EAAE,EAAE,IAAI,CAAC,GAAG,EAAE,EAAE,QAAQ,CAAC,IAAI,EAAE,EAAE,KAAK,GAAG,EAAE,QAAQ,CAAC,KAAK,CAAC,EAAE,IAAI,CAAC,IAAI;;wCAEvE,EAAE,OAAO,OAAO,CAAC,GAAG;;;;;IAKxD,CAAC;IAED,oBAAoB,CAAC,SAAiB,QAAgB,YAAoB,aAAuB,CAAC;;;;6CAIzD,EAAE,QAAQ,uBAAuB,EAAE,OAAO,OAAO,CAAC,GAAG;;;sEAG5B,EAAE,WAAW;;;;;;qBAM9D,EAAE,WAAW;;;;IAI9B,CAAC;IAED,eAAe,CAAC,SAAiB,UAAoB,CAAC;;;wEAGc,EAAE,QAAQ;;;;kDAIhC,EAAE,QAAQ;;;;;IAKxD,CAAC;IAED,aAAa,CAAC,UAAoB,CAAC;;;6FAGsD,EAAE,QAAQ;;;;IAInG,CAAC;AACL"}},
    {"offset": {"line": 519, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/Dhanush/agronova/app/api/store/order/create/route.ts"],"sourcesContent":["import { NextResponse } from 'next/server';\r\nimport { dbOrders } from '@/lib/db';\r\nimport { sendVerificationEmail } from '@/lib/email'; \r\nimport { EmailTemplate } from '@/lib/email-templates';\r\n\r\n// We need a way to send generic email, assuming 'sendVerificationEmail' is adaptable or we create a new helper.\r\n// For now, I will assume we can reuse the transporter logic but I might need to export the transporter or create 'sendEmail'.\r\n\r\nimport nodemailer from 'nodemailer';\r\n\r\nconst transporter = nodemailer.createTransport({\r\n    service: 'gmail',\r\n    auth: {\r\n        user: process.env.EMAIL_USER,\r\n        pass: process.env.EMAIL_PASS,\r\n    },\r\n});\r\n\r\nasync function sendMail(to: string, subject: string, html: string) {\r\n    try {\r\n        await transporter.sendMail({\r\n            from: process.env.EMAIL_USER,\r\n            to,\r\n            subject,\r\n            html,\r\n        });\r\n        return true;\r\n    } catch (e) {\r\n        console.error(\"Email Error:\", e);\r\n        return false;\r\n    }\r\n}\r\n\r\nexport async function POST(req: Request) {\r\n    try {\r\n        const body = await req.json();\r\n        const { orderId, cart, total, address, sellerGroups, userInputs, buyerEmail } = body;\r\n\r\n        // In a real app, we handle multiple sellers. For MVP, we treat the 'checkout' as one order per seller, or one mixed order.\r\n        // The user requirements imply \"The Seller\" receives verification. \r\n        // If there are multiple sellers, we should split them.\r\n        // Let's assume we loop through sellerGroups.\r\n\r\n        const results = [];\r\n\r\n        // 2. Iterate Seller Groups -> Create Sub-Orders\r\n        const createdOrders = [];\r\n        const entries = Object.entries(sellerGroups);\r\n\r\n        for (const [vpa, group] of entries) {\r\n            const sellerGroup = group as any;\r\n            // Extract Seller Email from the first item (assuming same seller per group)\r\n            // Extract Seller Email from the first item (assuming same seller per group)\r\n            const sellerEmail = sellerGroup.items[0]?.sellerEmail || process.env.EMAIL_USER || \"admin@agronova.com\"; \r\n            \r\n            // Create Order in DB\r\n            const newOrder = await dbOrders.create({\r\n                id: `ORD-${Date.now()}-${Math.floor(Math.random()*1000)}`,\r\n                status: 'PENDING_SELLER',\r\n                createdAt: new Date().toISOString(),\r\n                tries: 0,\r\n                buyerEmail: body.buyerEmail, \r\n                sellerVpa: vpa,\r\n                amount: sellerGroup.total,\r\n                items: sellerGroup.items,\r\n                buyerUpiIndex: userInputs[vpa] || \"UNKNOWN\", \r\n                shippingAddress: address || \"No address provided\"\r\n            });\r\n\r\n            createdOrders.push(newOrder);\r\n\r\n            // 3. Send Sub-Order Emails\r\n            \r\n            // A. Send Invoice to Buyer\r\n            await transporter.sendMail({\r\n                from: '\"AgriStore\" <' + process.env.EMAIL_USER + '>',\r\n                to: body.buyerEmail, // Real Buyer\r\n                subject: `Order Placed: ${newOrder.id}`,\r\n                html: EmailTemplate.Invoice(newOrder.id, newOrder.amount, newOrder.items) // Assuming EmailTemplate.Invoice takes (id, amount, items)\r\n            });\r\n\r\n            // B. Send Verification Request to Seller\r\n            const verifyLink = `http://localhost:3000/verify-order?orderId=${newOrder.id}`; // Generate verify link\r\n            await transporter.sendMail({\r\n                from: '\"AgriStore System\" <' + process.env.EMAIL_USER + '>',\r\n                to: sellerEmail, // Real Seller\r\n                subject: `Action Required: Verify Payment for ${newOrder.id}`,\r\n                html: EmailTemplate.SellerVerification(newOrder.id, newOrder.amount, newOrder.buyerUpiIndex || \"\", verifyLink) // Assuming EmailTemplate.SellerVerification takes (id, amount, buyerUpiIndex, verifyLink)\r\n            });\r\n        }\r\n\r\n        return NextResponse.json({ success: true, orders: createdOrders });\r\n\r\n    } catch (e) {\r\n        console.error(\"Values Error:\", e);\r\n        return NextResponse.json({ error: \"Failed to create order\" }, { status: 500 });\r\n    }\r\n}\r\n"],"names":[],"mappings":";;;;AAAA;AACA;AAEA;AAEA,gHAAgH;AAChH,8HAA8H;AAE9H;;;;;AAEA,MAAM,cAAc,wKAAU,CAAC,eAAe,CAAC;IAC3C,SAAS;IACT,MAAM;QACF,MAAM,QAAQ,GAAG,CAAC,UAAU;QAC5B,MAAM,QAAQ,GAAG,CAAC,UAAU;IAChC;AACJ;AAEA,eAAe,SAAS,EAAU,EAAE,OAAe,EAAE,IAAY;IAC7D,IAAI;QACA,MAAM,YAAY,QAAQ,CAAC;YACvB,MAAM,QAAQ,GAAG,CAAC,UAAU;YAC5B;YACA;YACA;QACJ;QACA,OAAO;IACX,EAAE,OAAO,GAAG;QACR,QAAQ,KAAK,CAAC,gBAAgB;QAC9B,OAAO;IACX;AACJ;AAEO,eAAe,KAAK,GAAY;IACnC,IAAI;QACA,MAAM,OAAO,MAAM,IAAI,IAAI;QAC3B,MAAM,EAAE,OAAO,EAAE,IAAI,EAAE,KAAK,EAAE,OAAO,EAAE,YAAY,EAAE,UAAU,EAAE,UAAU,EAAE,GAAG;QAEhF,2HAA2H;QAC3H,mEAAmE;QACnE,uDAAuD;QACvD,6CAA6C;QAE7C,MAAM,UAAU,EAAE;QAElB,gDAAgD;QAChD,MAAM,gBAAgB,EAAE;QACxB,MAAM,UAAU,OAAO,OAAO,CAAC;QAE/B,KAAK,MAAM,CAAC,KAAK,MAAM,IAAI,QAAS;YAChC,MAAM,cAAc;YACpB,4EAA4E;YAC5E,4EAA4E;YAC5E,MAAM,cAAc,YAAY,KAAK,CAAC,EAAE,EAAE,eAAe,QAAQ,GAAG,CAAC,UAAU,IAAI;YAEnF,qBAAqB;YACrB,MAAM,WAAW,MAAM,mIAAQ,CAAC,MAAM,CAAC;gBACnC,IAAI,CAAC,IAAI,EAAE,KAAK,GAAG,GAAG,CAAC,EAAE,KAAK,KAAK,CAAC,KAAK,MAAM,KAAG,OAAO;gBACzD,QAAQ;gBACR,WAAW,IAAI,OAAO,WAAW;gBACjC,OAAO;gBACP,YAAY,KAAK,UAAU;gBAC3B,WAAW;gBACX,QAAQ,YAAY,KAAK;gBACzB,OAAO,YAAY,KAAK;gBACxB,eAAe,UAAU,CAAC,IAAI,IAAI;gBAClC,iBAAiB,WAAW;YAChC;YAEA,cAAc,IAAI,CAAC;YAEnB,2BAA2B;YAE3B,2BAA2B;YAC3B,MAAM,YAAY,QAAQ,CAAC;gBACvB,MAAM,kBAAkB,QAAQ,GAAG,CAAC,UAAU,GAAG;gBACjD,IAAI,KAAK,UAAU;gBACnB,SAAS,CAAC,cAAc,EAAE,SAAS,EAAE,EAAE;gBACvC,MAAM,wJAAa,CAAC,OAAO,CAAC,SAAS,EAAE,EAAE,SAAS,MAAM,EAAE,SAAS,KAAK,EAAE,2DAA2D;YACzI;YAEA,yCAAyC;YACzC,MAAM,aAAa,CAAC,2CAA2C,EAAE,SAAS,EAAE,EAAE,EAAE,uBAAuB;YACvG,MAAM,YAAY,QAAQ,CAAC;gBACvB,MAAM,yBAAyB,QAAQ,GAAG,CAAC,UAAU,GAAG;gBACxD,IAAI;gBACJ,SAAS,CAAC,oCAAoC,EAAE,SAAS,EAAE,EAAE;gBAC7D,MAAM,wJAAa,CAAC,kBAAkB,CAAC,SAAS,EAAE,EAAE,SAAS,MAAM,EAAE,SAAS,aAAa,IAAI,IAAI,YAAY,0FAA0F;YAC7M;QACJ;QAEA,OAAO,4JAAY,CAAC,IAAI,CAAC;YAAE,SAAS;YAAM,QAAQ;QAAc;IAEpE,EAAE,OAAO,GAAG;QACR,QAAQ,KAAK,CAAC,iBAAiB;QAC/B,OAAO,4JAAY,CAAC,IAAI,CAAC;YAAE,OAAO;QAAyB,GAAG;YAAE,QAAQ;QAAI;IAChF;AACJ"}}]
}