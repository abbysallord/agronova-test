{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 46, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/Dhanush/agronova/app/api/analyze-crop/route.ts"],"sourcesContent":["import { Mistral } from \"@mistralai/mistralai\";\r\nimport { NextResponse } from \"next/server\";\r\n\r\nexport async function POST(req: Request) {\r\n  try {\r\n    const formData = await req.formData();\r\n    const file = formData.get(\"image\") as File;\r\n\r\n    if (!file) {\r\n      return NextResponse.json({ error: \"No image provided\" }, { status: 400 });\r\n    }\r\n\r\n    if (!process.env.MISTRAL_API_KEY) {\r\n        return NextResponse.json({ error: \"MISTRAL_API_KEY not configured\" }, { status: 500 });\r\n    }\r\n\r\n    const arrayBuffer = await file.arrayBuffer();\r\n    const buffer = Buffer.from(arrayBuffer);\r\n    const base64Image = buffer.toString(\"base64\");\r\n    const dataUrl = `data:${file.type};base64,${base64Image}`;\r\n\r\n    const client = new Mistral({\r\n      apiKey: process.env.MISTRAL_API_KEY,\r\n    });\r\n\r\n    const prompt = `Analyze this crop image for pests or diseases. \r\n    Return ONLY a valid JSON object with the following structure (do NOT include markdown formatting like \\`\\`\\`json):\r\n    {\r\n      \"disease\": \"Name of disease or 'Healthy'\",\r\n      \"crop\": \"Name of crop\",\r\n      \"confidence\": \"e.g. 95%\",\r\n      \"severity\": \"Low | Moderate | High | Critical | None\",\r\n      \"symptoms\": \"Detailed explanation of symptoms in simple, farmer-friendly language. Explain WHY this is happening.\",\r\n      \"cure\": {\r\n        \"chemical\": \"Detailed step-by-step chemical treatment instructions. Include dosage if applicable.\",\r\n        \"organic\": \"Detailed organic or home-remedy treatment steps. Explain how to prepare and apply.\"\r\n      },\r\n      \"prevention\": \"Comprehensive list of prevention tips for future seasons. Write as a simple paragraph.\",\r\n      \"type\": \"disease | healthy\"\r\n    }\r\n    If the image is not a plant/crop, return {\"error\": \"Not a crop image\"}.\r\n    IMPORTANT: Write for a farmer. Use simple, clear, and encouraging language. Avoid overly complex jaragon. be detailed but easy to understand.`;\r\n\r\n    const response = await client.chat.complete({\r\n      model: \"pixtral-12b-2409\",\r\n      messages: [\r\n        {\r\n          role: \"user\",\r\n          content: [\r\n            { type: \"text\", text: prompt },\r\n            { \r\n                type: \"image_url\", \r\n                imageUrl: dataUrl \r\n            },\r\n          ],\r\n        },\r\n      ],\r\n      responseFormat: { type: \"json_object\" },\r\n    });\r\n\r\n    const content = response.choices?.[0]?.message?.content;\r\n\r\n    if (!content) {\r\n        throw new Error(\"No content received from AI\");\r\n    }\r\n\r\n    try {\r\n        // Sometimes models wrap in markdown despite instructions, so we clean it just in case\r\n        const cleanText = (content as string).replace(/```json/g, '').replace(/```/g, '').trim();\r\n        const jsonResponse = JSON.parse(cleanText);\r\n        return NextResponse.json(jsonResponse);\r\n    } catch (e) {\r\n        console.error(\"JSON Parse Error:\", content);\r\n        return NextResponse.json({ error: \"Failed to parse AI response\", details: content }, { status: 500 });\r\n    }\r\n\r\n  } catch (error: any) {\r\n    console.error(\"Analysis Error:\", error);\r\n    return NextResponse.json({ \r\n        error: error.message || \"Internal Server Error\", \r\n        details: error.toString() \r\n    }, { status: 500 });\r\n  }\r\n}\r\n"],"names":[],"mappings":";;;;AAAA;AACA;;;AAEO,eAAe,KAAK,GAAY;IACrC,IAAI;QACF,MAAM,WAAW,MAAM,IAAI,QAAQ;QACnC,MAAM,OAAO,SAAS,GAAG,CAAC;QAE1B,IAAI,CAAC,MAAM;YACT,OAAO,4JAAY,CAAC,IAAI,CAAC;gBAAE,OAAO;YAAoB,GAAG;gBAAE,QAAQ;YAAI;QACzE;QAEA,IAAI,CAAC,QAAQ,GAAG,CAAC,eAAe,EAAE;YAC9B,OAAO,4JAAY,CAAC,IAAI,CAAC;gBAAE,OAAO;YAAiC,GAAG;gBAAE,QAAQ;YAAI;QACxF;QAEA,MAAM,cAAc,MAAM,KAAK,WAAW;QAC1C,MAAM,SAAS,OAAO,IAAI,CAAC;QAC3B,MAAM,cAAc,OAAO,QAAQ,CAAC;QACpC,MAAM,UAAU,CAAC,KAAK,EAAE,KAAK,IAAI,CAAC,QAAQ,EAAE,aAAa;QAEzD,MAAM,SAAS,IAAI,0KAAO,CAAC;YACzB,QAAQ,QAAQ,GAAG,CAAC,eAAe;QACrC;QAEA,MAAM,SAAS,CAAC;;;;;;;;;;;;;;;;iJAgB6H,CAAC;QAE9I,MAAM,WAAW,MAAM,OAAO,IAAI,CAAC,QAAQ,CAAC;YAC1C,OAAO;YACP,UAAU;gBACR;oBACE,MAAM;oBACN,SAAS;wBACP;4BAAE,MAAM;4BAAQ,MAAM;wBAAO;wBAC7B;4BACI,MAAM;4BACN,UAAU;wBACd;qBACD;gBACH;aACD;YACD,gBAAgB;gBAAE,MAAM;YAAc;QACxC;QAEA,MAAM,UAAU,SAAS,OAAO,EAAE,CAAC,EAAE,EAAE,SAAS;QAEhD,IAAI,CAAC,SAAS;YACV,MAAM,IAAI,MAAM;QACpB;QAEA,IAAI;YACA,sFAAsF;YACtF,MAAM,YAAY,AAAC,QAAmB,OAAO,CAAC,YAAY,IAAI,OAAO,CAAC,QAAQ,IAAI,IAAI;YACtF,MAAM,eAAe,KAAK,KAAK,CAAC;YAChC,OAAO,4JAAY,CAAC,IAAI,CAAC;QAC7B,EAAE,OAAO,GAAG;YACR,QAAQ,KAAK,CAAC,qBAAqB;YACnC,OAAO,4JAAY,CAAC,IAAI,CAAC;gBAAE,OAAO;gBAA+B,SAAS;YAAQ,GAAG;gBAAE,QAAQ;YAAI;QACvG;IAEF,EAAE,OAAO,OAAY;QACnB,QAAQ,KAAK,CAAC,mBAAmB;QACjC,OAAO,4JAAY,CAAC,IAAI,CAAC;YACrB,OAAO,MAAM,OAAO,IAAI;YACxB,SAAS,MAAM,QAAQ;QAC3B,GAAG;YAAE,QAAQ;QAAI;IACnB;AACF"}}]
}