{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 46, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/Dhanush/agronova/app/api/market-price/route.ts"],"sourcesContent":["import { NextResponse } from \"next/server\";\r\nimport { Mistral } from \"@mistralai/mistralai\";\r\n\r\nconst client = new Mistral({\r\n  apiKey: process.env.MISTRAL_API_KEY,\r\n});\r\n\r\nexport async function POST(req: Request) {\r\n  try {\r\n    const { crop, state, district } = await req.json();\r\n\r\n    if (!crop) {\r\n        return NextResponse.json({ error: \"Crop name is required\" }, { status: 400 });\r\n    }\r\n\r\n    const normalizedCrop = crop.toLowerCase().trim();\r\n    // Public key from data.gov.in (often rate limited, so we handle failure)\r\n    const GOV_API_KEY = \"579b464db66ec23bdd000001cdd3946e44ce4aad7209ff7b23ac571b\"; \r\n    \r\n    let marketData = [];\r\n    let dataSource = \"gov_api\"; // or \"ai_estimate\"\r\n\r\n    // 1. Try Fetching from Government API\r\n    try {\r\n        console.log(`Fetching Gov API for ${crop} in ${state}...`);\r\n        // Resource ID for Agmarknet Daily Prices: 9ef84268-d588-465a-a308-a864a43d0070\r\n        const stateFilter = state !== \"All States\" ? `&filters[state_name]=${encodeURIComponent(state)}` : \"\";\r\n        const cropFilter = `&filters[commodity]=${encodeURIComponent(crop)}`;\r\n        \r\n        const govUrl = `https://api.data.gov.in/resource/9ef84268-d588-465a-a308-a864a43d0070?api-key=${GOV_API_KEY}&format=json${stateFilter}${cropFilter}&limit=10`;\r\n        \r\n        const govRes = await fetch(govUrl);\r\n        const govJson = await govRes.json();\r\n        \r\n        if (govJson.records && govJson.records.length > 0) {\r\n            marketData = govJson.records.map((record: any) => ({\r\n                market: record.market || record.district,\r\n                state: record.state,\r\n                price: Number(record.modal_price),\r\n                variety: record.variety,\r\n                change: 0 // API doesn't give trend, assume 0\r\n            }));\r\n            console.log(\"Gov API Success!\");\r\n        } else {\r\n            console.warn(\"Gov API returned no records. Switching to AI.\");\r\n            dataSource = \"ai_estimate\";\r\n        }\r\n    } catch (e) {\r\n        console.error(\"Gov API Failed (Rate Limit or Error):\", e);\r\n        dataSource = \"ai_estimate\";\r\n    }\r\n\r\n    // 2. Fallback to AI if Gov API failed or empty\r\n    if (dataSource === \"ai_estimate\") {\r\n        return await generateAiEstimate(crop, state, normalizedCrop, client);\r\n    }\r\n\r\n    // Return Real Data\r\n    const prices = marketData.map((d: any) => d.price);\r\n    const avg = prices.reduce((a: number, b: number) => a + b, 0) / prices.length;\r\n    \r\n    return NextResponse.json({\r\n        market_data: marketData,\r\n        average_price: avg,\r\n        source: \"Government (Agmarknet)\",\r\n        highest_price: Math.max(...prices),\r\n    });\r\n\r\n  } catch (error: any) {\r\n    console.error(\"Market Price API Error:\", error);\r\n    return NextResponse.json({ error: \"Failed to fetch market prices\" }, { status: 500 });\r\n  }\r\n}\r\n\r\n// Helper for AI Fallback with Real-Time Search (RAG)\r\nasync function generateAiEstimate(crop: string, state: string, normalizedCrop: string, client: Mistral) {\r\n    const stateQuery = state && state !== \"All States\" ? `in ${state}` : \"across major Indian states\";\r\n    \r\n    // 1. Perform Real-Time Web Search (DuckDuckGo HTML Scraping)\r\n    let searchContext = \"\";\r\n    let topSourceUrl = \"\";\r\n    let topSourceDomain = \"\";\r\n\r\n    try {\r\n        const query = `current market price of ${crop} ${stateQuery} today latest news agriculture`;\r\n        console.log(\"Searching Web:\", query);\r\n        \r\n        const res = await fetch(`https://html.duckduckgo.com/html?q=${encodeURIComponent(query)}`, {\r\n            headers: {\r\n                \"User-Agent\": \"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36\"\r\n            }\r\n        });\r\n        \r\n        const html = await res.text();\r\n        \r\n        // Structure: <div class=\"result__body\"> ... <a class=\"result__a\" href=\"...\">Title</a> ... <a class=\"result__snippet\" href=\"...\">Snippet</a>\r\n        const results = [];\r\n        const bodyRegex = /<div[^>]*class=\"result__body\"[^>]*>(.*?)<\\/div>/g;\r\n        let bodyMatch;\r\n        \r\n        const trustedDomains = [\"agmarknet\", \"commodityonline\", \"krishijagran\", \"economictimes\", \"mandibhav\"];\r\n\r\n        while ((bodyMatch = bodyRegex.exec(html)) !== null) {\r\n            const block = bodyMatch[1];\r\n            const titleMatch = /class=\"result__a\"[^>]*>(.*?)<\\/a>/.exec(block);\r\n            const snippetMatch = /class=\"result__snippet\"[^>]*>(.*?)<\\/a>/.exec(block);\r\n            const urlMatch = /href=\"(.*?)\"/.exec(titleMatch?.[0] || \"\");\r\n            \r\n            if (titleMatch && snippetMatch && urlMatch) {\r\n                const url = urlMatch[1];\r\n                const cleanSnippet = snippetMatch[1].replace(/<[^>]*>/g, '').trim();\r\n                const domain = new URL(url).hostname.replace('www.', '');\r\n                \r\n                results.push({ domain, url, snippet: cleanSnippet });\r\n                \r\n                if (!topSourceUrl && trustedDomains.some(d => domain.includes(d))) {\r\n                    topSourceUrl = url;\r\n                    topSourceDomain = domain;\r\n                }\r\n            }\r\n        }\r\n\r\n        searchContext = results.slice(0, 15).map(r => `[Source: ${r.domain}] ${r.snippet}`).join(\"\\n\\n\");\r\n        if (!topSourceUrl && results.length > 0) {\r\n             topSourceUrl = results[0].url;\r\n             topSourceDomain = results[0].domain;\r\n        }\r\n\r\n        console.log(\"Search Context:\", results.length, \"results. Top Source:\", topSourceDomain);\r\n\r\n    } catch (e) {\r\n        console.error(\"Web Search Failed:\", e);\r\n        searchContext = \"Web search unavailable. Use your knowledge base.\";\r\n    }\r\n\r\n    const prompt = `\r\n    You are an expert Agriculture Market Analyst in India.\r\n    Date: ${new Date().toLocaleDateString('en-IN', { year: 'numeric', month: 'long', day: 'numeric' })}.\r\n    \r\n    Task: Generate a REAL-TIME market price report for \"${crop}\" ${stateQuery}, based on the following SEARCH RESULTS.\r\n    \r\n    SEARCH CONTEXT:\r\n    ${searchContext}\r\n    \r\n    INSTRUCTIONS:\r\n    1. ANALYZE the snippets to find the most recent and credible price.\r\n    2. EXTRACT real prices. If context says \"Rs 20/kg\", multiply by 100 -> 2000/quintal.\r\n    3. MANDIS: List ALL distinct mandis found in the context. Aim for 8-12 mandis if data exists.\r\n    4. TREND: Deduce from news (rising/falling).\r\n\r\n    OUTPUT FORMAT (JSON ONLY):\r\n    {\r\n        \"market_data\": [\r\n            { \"market\": \"Mandi Name\", \"state\": \"State Name\", \"price\": 0, \"change\": 0.0, \"variety\": \"Local/Hybrid\" } \r\n        ],\r\n        \"average_price\": 0,\r\n        \"highest_price\": 0,\r\n        \"source\": \"AI Search\",\r\n        \"source_url\": \"${topSourceUrl}\",\r\n        \"source_domain\": \"${topSourceDomain}\"\r\n    }\r\n    `;\r\n\r\n    const response = await client.chat.complete({\r\n      model: \"mistral-small-latest\",\r\n      messages: [{ role: \"user\", content: prompt }],\r\n      responseFormat: { type: \"json_object\" },\r\n    });\r\n\r\n    const content = response.choices && response.choices[0] && response.choices[0].message.content as string;\r\n    \r\n    if (!content) throw new Error(\"No content from AI\");\r\n    \r\n    // Safety check for source_url in AI response, though we injected it\r\n    const parsed = JSON.parse(content);\r\n    if (!parsed.source_url) {\r\n        parsed.source_url = topSourceUrl;\r\n        parsed.source_domain = topSourceDomain;\r\n    }\r\n    return NextResponse.json(parsed);\r\n}\r\n"],"names":[],"mappings":";;;;AAAA;AACA;;;AAEA,MAAM,SAAS,IAAI,0KAAO,CAAC;IACzB,QAAQ,QAAQ,GAAG,CAAC,eAAe;AACrC;AAEO,eAAe,KAAK,GAAY;IACrC,IAAI;QACF,MAAM,EAAE,IAAI,EAAE,KAAK,EAAE,QAAQ,EAAE,GAAG,MAAM,IAAI,IAAI;QAEhD,IAAI,CAAC,MAAM;YACP,OAAO,4JAAY,CAAC,IAAI,CAAC;gBAAE,OAAO;YAAwB,GAAG;gBAAE,QAAQ;YAAI;QAC/E;QAEA,MAAM,iBAAiB,KAAK,WAAW,GAAG,IAAI;QAC9C,yEAAyE;QACzE,MAAM,cAAc;QAEpB,IAAI,aAAa,EAAE;QACnB,IAAI,aAAa,WAAW,mBAAmB;QAE/C,sCAAsC;QACtC,IAAI;YACA,QAAQ,GAAG,CAAC,CAAC,qBAAqB,EAAE,KAAK,IAAI,EAAE,MAAM,GAAG,CAAC;YACzD,+EAA+E;YAC/E,MAAM,cAAc,UAAU,eAAe,CAAC,qBAAqB,EAAE,mBAAmB,QAAQ,GAAG;YACnG,MAAM,aAAa,CAAC,oBAAoB,EAAE,mBAAmB,OAAO;YAEpE,MAAM,SAAS,CAAC,8EAA8E,EAAE,YAAY,YAAY,EAAE,cAAc,WAAW,SAAS,CAAC;YAE7J,MAAM,SAAS,MAAM,MAAM;YAC3B,MAAM,UAAU,MAAM,OAAO,IAAI;YAEjC,IAAI,QAAQ,OAAO,IAAI,QAAQ,OAAO,CAAC,MAAM,GAAG,GAAG;gBAC/C,aAAa,QAAQ,OAAO,CAAC,GAAG,CAAC,CAAC,SAAgB,CAAC;wBAC/C,QAAQ,OAAO,MAAM,IAAI,OAAO,QAAQ;wBACxC,OAAO,OAAO,KAAK;wBACnB,OAAO,OAAO,OAAO,WAAW;wBAChC,SAAS,OAAO,OAAO;wBACvB,QAAQ,EAAE,mCAAmC;oBACjD,CAAC;gBACD,QAAQ,GAAG,CAAC;YAChB,OAAO;gBACH,QAAQ,IAAI,CAAC;gBACb,aAAa;YACjB;QACJ,EAAE,OAAO,GAAG;YACR,QAAQ,KAAK,CAAC,yCAAyC;YACvD,aAAa;QACjB;QAEA,+CAA+C;QAC/C,IAAI,eAAe,eAAe;YAC9B,OAAO,MAAM,mBAAmB,MAAM,OAAO,gBAAgB;QACjE;QAEA,mBAAmB;QACnB,MAAM,SAAS,WAAW,GAAG,CAAC,CAAC,IAAW,EAAE,KAAK;QACjD,MAAM,MAAM,OAAO,MAAM,CAAC,CAAC,GAAW,IAAc,IAAI,GAAG,KAAK,OAAO,MAAM;QAE7E,OAAO,4JAAY,CAAC,IAAI,CAAC;YACrB,aAAa;YACb,eAAe;YACf,QAAQ;YACR,eAAe,KAAK,GAAG,IAAI;QAC/B;IAEF,EAAE,OAAO,OAAY;QACnB,QAAQ,KAAK,CAAC,2BAA2B;QACzC,OAAO,4JAAY,CAAC,IAAI,CAAC;YAAE,OAAO;QAAgC,GAAG;YAAE,QAAQ;QAAI;IACrF;AACF;AAEA,qDAAqD;AACrD,eAAe,mBAAmB,IAAY,EAAE,KAAa,EAAE,cAAsB,EAAE,MAAe;IAClG,MAAM,aAAa,SAAS,UAAU,eAAe,CAAC,GAAG,EAAE,OAAO,GAAG;IAErE,6DAA6D;IAC7D,IAAI,gBAAgB;IACpB,IAAI,eAAe;IACnB,IAAI,kBAAkB;IAEtB,IAAI;QACA,MAAM,QAAQ,CAAC,wBAAwB,EAAE,KAAK,CAAC,EAAE,WAAW,8BAA8B,CAAC;QAC3F,QAAQ,GAAG,CAAC,kBAAkB;QAE9B,MAAM,MAAM,MAAM,MAAM,CAAC,mCAAmC,EAAE,mBAAmB,QAAQ,EAAE;YACvF,SAAS;gBACL,cAAc;YAClB;QACJ;QAEA,MAAM,OAAO,MAAM,IAAI,IAAI;QAE3B,4IAA4I;QAC5I,MAAM,UAAU,EAAE;QAClB,MAAM,YAAY;QAClB,IAAI;QAEJ,MAAM,iBAAiB;YAAC;YAAa;YAAmB;YAAgB;YAAiB;SAAY;QAErG,MAAO,CAAC,YAAY,UAAU,IAAI,CAAC,KAAK,MAAM,KAAM;YAChD,MAAM,QAAQ,SAAS,CAAC,EAAE;YAC1B,MAAM,aAAa,oCAAoC,IAAI,CAAC;YAC5D,MAAM,eAAe,0CAA0C,IAAI,CAAC;YACpE,MAAM,WAAW,eAAe,IAAI,CAAC,YAAY,CAAC,EAAE,IAAI;YAExD,IAAI,cAAc,gBAAgB,UAAU;gBACxC,MAAM,MAAM,QAAQ,CAAC,EAAE;gBACvB,MAAM,eAAe,YAAY,CAAC,EAAE,CAAC,OAAO,CAAC,YAAY,IAAI,IAAI;gBACjE,MAAM,SAAS,IAAI,IAAI,KAAK,QAAQ,CAAC,OAAO,CAAC,QAAQ;gBAErD,QAAQ,IAAI,CAAC;oBAAE;oBAAQ;oBAAK,SAAS;gBAAa;gBAElD,IAAI,CAAC,gBAAgB,eAAe,IAAI,CAAC,CAAA,IAAK,OAAO,QAAQ,CAAC,KAAK;oBAC/D,eAAe;oBACf,kBAAkB;gBACtB;YACJ;QACJ;QAEA,gBAAgB,QAAQ,KAAK,CAAC,GAAG,IAAI,GAAG,CAAC,CAAA,IAAK,CAAC,SAAS,EAAE,EAAE,MAAM,CAAC,EAAE,EAAE,EAAE,OAAO,EAAE,EAAE,IAAI,CAAC;QACzF,IAAI,CAAC,gBAAgB,QAAQ,MAAM,GAAG,GAAG;YACpC,eAAe,OAAO,CAAC,EAAE,CAAC,GAAG;YAC7B,kBAAkB,OAAO,CAAC,EAAE,CAAC,MAAM;QACxC;QAEA,QAAQ,GAAG,CAAC,mBAAmB,QAAQ,MAAM,EAAE,wBAAwB;IAE3E,EAAE,OAAO,GAAG;QACR,QAAQ,KAAK,CAAC,sBAAsB;QACpC,gBAAgB;IACpB;IAEA,MAAM,SAAS,CAAC;;UAEV,EAAE,IAAI,OAAO,kBAAkB,CAAC,SAAS;QAAE,MAAM;QAAW,OAAO;QAAQ,KAAK;IAAU,GAAG;;wDAE/C,EAAE,KAAK,EAAE,EAAE,WAAW;;;IAG1E,EAAE,cAAc;;;;;;;;;;;;;;;;uBAgBG,EAAE,aAAa;0BACZ,EAAE,gBAAgB;;IAExC,CAAC;IAED,MAAM,WAAW,MAAM,OAAO,IAAI,CAAC,QAAQ,CAAC;QAC1C,OAAO;QACP,UAAU;YAAC;gBAAE,MAAM;gBAAQ,SAAS;YAAO;SAAE;QAC7C,gBAAgB;YAAE,MAAM;QAAc;IACxC;IAEA,MAAM,UAAU,SAAS,OAAO,IAAI,SAAS,OAAO,CAAC,EAAE,IAAI,SAAS,OAAO,CAAC,EAAE,CAAC,OAAO,CAAC,OAAO;IAE9F,IAAI,CAAC,SAAS,MAAM,IAAI,MAAM;IAE9B,oEAAoE;IACpE,MAAM,SAAS,KAAK,KAAK,CAAC;IAC1B,IAAI,CAAC,OAAO,UAAU,EAAE;QACpB,OAAO,UAAU,GAAG;QACpB,OAAO,aAAa,GAAG;IAC3B;IACA,OAAO,4JAAY,CAAC,IAAI,CAAC;AAC7B"}}]
}